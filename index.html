<script>
    var webstore = new Vue({
        el: '#app',
        data: {
            pageTitle: 'NextGen Learning',
            cart: [],
            showCheckoutPage: false,
            showLessons: true,
            lessons: [],
            searchQuery: '',
            order: {
                firstName: '',
                lastName: '',
                address: '',
                city: '',
                state: '',
                zip: ''
            },
            orderSubmitted: false,
            sortOrder: null,
            loading: false,  // Add loading state
        },
        created() {
            this.fetchLessons();
        },
        methods: {
            async fetchLessons() {
                this.loading = true;  // Set loading to true when the fetch starts
                try {
                    const response = await fetch('https://expressrenders-rest-api3.onrender.com/collections/lessons');
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    this.lessons = await response.json();
                } catch (error) {
                    console.error('Error fetching lessons:', error);
                    alert('Failed to load lessons. Please try again later.');
                } finally {
                    this.loading = false;  // Set loading to false once fetch is complete
                }
            },
            addToCart(lesson) {
                if (this.canAddToCart(lesson)) {
                    this.cart.push(lesson);
                }
            },
            canAddToCart(lesson) {
                return this.itemsLeft(lesson) > 0;
            },
            itemsLeft(lesson) {
                const itemsInCart = this.cart.filter(item => item.title === lesson.title).length;
                return lesson.availableInventory - itemsInCart;
            },
            toggleCheckout() {
                this.showCheckoutPage = !this.showCheckoutPage;
            },
            submitForm() {
                alert('Registration Completed!');
                this.orderSubmitted = true;
            },
            sortByPrice(order) {
                this.sortOrder = order;
            },
            totalPrice() {
                return this.cart.reduce((total, lesson) => total + lesson.price, 0);
            },

            // Remove item from cart
            removeFromCart(lesson, index) {
                this.cart.splice(index, 1);
            }
        },
        computed: {
            filteredLessons() {
                let lessonsToShow = this.lessons.filter(lesson =>
                    lesson.title.toLowerCase().includes(this.searchQuery.toLowerCase())
                );
                if (this.sortOrder === 'asc') {
                    return lessonsToShow.sort((a, b) => a.price - b.price);
                } else if (this.sortOrder === 'desc') {
                    return lessonsToShow.sort((a, b) => b.price - a.price);
                } else {
                    return lessonsToShow;
                }
            }
        }
    });
</script>
